---
applyTo: "./app/**/*"
description: ソフトウェアコンポーネント、モジュールの結合の評価を行う
---

# 結合を評価するモデル
以下のURLで説明されているBalancing coupling in software design(ソフトウェア設計における均衡結合)というモデルを用いて、ソフトウェアの結合について評価する。
- https://coupling.dev/
- https://speakerdeck.com/vladikk/balancing-coupling-in-software-design-kandddinsky-2022

# ソフトウェア設計における均衡結合モデルの評価方法

システムのモジュールとは、自己完結型で、機能が責任として割り当てられカプセル化されたものであり、外部に機能を提供でき、独立してコンパイル可能なものをいう。
ソフトウェア設計における「均衡結合モデル」は、システムのモジュール性（変更しやすさ）と複雑性（理解・変更の難しさ）のバランスを取ることを目的としています。
これは、結合の「強度」「距離」「変動性」という3つの次元を考慮して評価されます。クラス設計と実装においてこのモデルを適用することで、変更に強く、保守しやすいシステムを構築できます。

## 1. 結合の3つの次元

均衡結合モデルを理解するには、以下の3つの次元を評価することが重要です。

* **強度 (Integration Strength)**: コンポーネント間で共有される知識の種類と範囲を示します。共有される知識が多いほど、結合は強くなり、連鎖的な変更の可能性が高まります。
    * **侵入結合 (Intrusive coupling)**: 上流モジュールの非公開な実装詳細に依存する最も強い結合。意図しない変更が頻繁に発生する可能性が高いです。
    * **機能結合 (Functional coupling)**: 密接に関連するビジネス機能を実装するモジュール間の結合。ビジネスロジックの変更が、結合されたすべてのモジュールに影響を与える可能性が高いです。
    * **モデル結合 (Model coupling)**: 複数のモジュールで同じビジネスドメインモデルが共有される結合。モデルの変更が連鎖的な変更を引き起こす可能性があります。
    * **コントラクト結合 (Contract coupling)**: 統合専用のモデル（コントラクト）を介して通信する最も弱い結合。公開される知識が最小限に抑えられ、安定性が高いです。

* **距離 (Distance)**: 結合されたコンポーネント間の物理的な配置の隔たりを示します。
    * 距離が近いほど、同時に変更、テスト、デプロイされる可能性が高く、変更の調整コストは低くなります。
    * 距離が遠いほど、変更を実装する際のコミュニケーションと調整の労力が増加します。
    * 物理的な配置だけでなく、組織構造（Conwayの法則）やランタイム結合（同期/非同期通信）も距離に影響を与えます。

* **変動性 (Volatility)**: コンポーネントが将来どれくらいの頻度で変更されると予想されるかを示します。
    * **コアサブドメイン**: 企業の競争優位性を生み出す機能であり、最も変動性が高いと予想されます。
    * **支援サブドメイン/汎用サブドメイン**: 競争優位性には直接寄与せず、変動性が低いと予想されます。
    * 変動性の高いコンポーネントにおける不適切な結合は、システムの複雑性を著しく増加させます。

## 2. 各次元のスケール
3 つの次元に対して、1（最低）から10（最高）の値を持つ任意のスケールを使用する。

- 統合強度
  – 1=コントラクト結合
  – 3=モデル結合
  – 8=機能結合
  – 9=対称機能結合
  – 10=侵入結合
- 距離
  – 1=同じオブジェクトのメソッド
  – 2=同じ名前空間／パッケージのオブジェクト
  – 3-7=異なる名前空間／パッケージのオブジェクト
  – 8=異なるライブラリ
  – 9=分散システムのサービス
  – 10=異なるベンダーによって実装されたシステム
- 変動性
  – 1=進化していないレガシーシステム
  – 3=サポートまたは汎用サブドメイン
  – 10=コア

## 3. 均衡結合の評価式

これらの3つの次元の関係は、システムの「モジュール性」と「複雑性」に影響を与えます。

* **モジュール性 (Modularity)**: 変更に対するシステムの適応能力。統合強度と距離の間の値の差異が大きいほどモジュール性が高まります。
    * `モジュール性 = |強度 - 距離| + 1`  (1-10のスケールで評価)

* **複雑性 (Complexity)**: システムの理解と変更の難しさ。統合強度と距離の値が類似しているほど複雑性が高まります。
    * `複雑性 = NOT (強度 XOR 距離)`
    * **局所的複雑性**: 低い強度と近い距離の組み合わせ。関連性のない機能が近くに配置され、認知負荷が増加します。
    * **大域的複雑性**: 高い強度と遠い距離の組み合わせ。遠く離れたモジュールへの頻繁な変更が、高い調整コストと複雑な相互作用を招きます。

最終的な「均衡度 (Balance)」は、モジュール性と変動性の関係によって評価されます。変動性が低い場合、複雑な結合であっても許容されることがあります。

* `均衡度 = max(|強度 - 距離|, 10 - 変動性) + 1`  (1-10のスケールで評価)

**評価の指針**:
* **高い均衡度** (例: 7以上) は、バランスの取れた設計であり、システムのモジュール性を高めます。
* **低い均衡度** (例: 3以下) は、バランスの悪い設計であり、システムの複雑性を増加させ、将来的な変更コストを高めます。

## 4. クラス設計・実装における適用方法 (Agentへの指示として)

Copilot Chatのエージェントとして、クラス設計と実装時に以下の点を考慮し、均衡結合モデルを用いて結合状態を評価するよう指示します。

1.  **目的の明確化**:
    * 「このクラス/モジュールが解決するビジネス上の問題は何ですか？ どのサブドメインに属しますか？ (コア、支援、汎用)」
    * これにより、そのクラス/モジュールの予想される「変動性」を判断します。

2.  **依存関係の特定**:
    * 「このクラス/モジュールが依存している他のクラス/モジュール/サービスは何ですか？」
    * 「このクラス/モジュールに依存している他のクラス/モジュール/サービスは何ですか？」

3.  **結合の強度の評価**:
    * 依存関係ごとに、「このクラス/モジュールは、相手のどの情報に依存していますか？ (実装詳細、ビジネス機能、モデル、統合コントラクト)」
    * 「その依存関係は、どの統合強度レベル（侵入結合、機能結合、モデル結合、コントラクト結合）に該当しますか？」
    * 可能な限り、より弱い結合（コントラクト結合）を目指します。

4.  **距離の評価**:
    * 依存関係にある各クラス/モジュールとの物理的な配置（同じファイル、同じ名前空間、異なるライブラリ、異なるサービスなど）を確認し、「距離」を評価します。
    * 開発チームの組織構造や、同期/非同期通信の利用も考慮に入れ、実質的な距離を評価します。

5.  **均衡度の計算と評価**:
    * 特定した「強度」「距離」「変動性」の各値を用いて、上記の「均衡度」の計算式を適用します。
    * 算出した均衡度スコアに基づき、その結合関係が適切かどうかを評価します。
    * 「この結合はバランスが取れていますか？ （スコアが高いですか？）」

6.  **改善の提案**:
    * もし均衡度が低い場合、以下の改善策を検討するよう指示します。
        * **統合強度の削減**: 不必要な知識共有をなくすリファクタリング（例: モデル結合からコントラクト結合への変更、DTOの導入など）。
        * **距離の調整**: 密接に関連するコンポーネントを近づけ、そうでないものを遠ざける（例: クラスの再編成、マイクロサービスへの分割、適切な抽象化境界の導入）。
        * **変動性の考慮**: 変動性の高いコンポーネントは、より低い統合強度またはより近い距離を持つべきです。

7.  **継続的な評価**:
    * 「新しい機能や要件が追加された場合、既存の結合の均衡が崩れていないか定期的に再評価してください。」
    * 「特にビジネス戦略の変更や組織変更があった場合は、サブドメインの変動性を再評価し、設計を調整することを忘れないでください。」

このフレームワークを使用することで、エージェントはコードベースの結合状態を体系的に評価し、よりモジュラーで保守しやすいソフトウェア設計へと導くことができます。
